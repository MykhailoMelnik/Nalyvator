#!/bin/bash

# –ó–º—ñ–Ω—é—î–º–æ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞
cd "$(dirname "$0")"

echo "üåê Nalyvator Config - –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫"
echo "================================"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ Java
if ! command -v java &> /dev/null; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: Java –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    echo "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Java –∑ https://java.com"
    read -p "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter –¥–ª—è –≤–∏—Ö–æ–¥—É..."
    exit 1
fi

echo "‚úÖ Java –∑–Ω–∞–π–¥–µ–Ω–∞: $(java -version 2>&1 | head -n 1)"

# –ö–æ–º–ø—ñ–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–∞–º—É
echo "üî® –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è..."
javac NalyvatorWebServer.java
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó!"
    read -p "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter –¥–ª—è –≤–∏—Ö–æ–¥—É..."
    exit 1
fi

echo "‚úÖ –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ –∑—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å–∏ –Ω–∞ –ø–æ—Ä—Ç—É 8081
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—Ç—É 8081..."
PORT_PID=$(lsof -ti:8081 2>/dev/null)
if [ ! -z "$PORT_PID" ]; then
    echo "üõë –ó—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å $PORT_PID –Ω–∞ –ø–æ—Ä—Ç—É 8081..."
    kill $PORT_PID 2>/dev/null
    sleep 1
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å –∑—É–ø–∏–Ω–µ–Ω–æ"
else
    echo "‚úÖ –ü–æ—Ä—Ç 8081 –≤—ñ–ª—å–Ω–∏–π"
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
java NalyvatorWebServer &
SERVER_PID=$!

# –ß–µ–∫–∞—î–º–æ 2 —Å–µ–∫—É–Ω–¥–∏
sleep 2

# –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –±—Ä–∞—É–∑–µ—Ä
echo "üåê –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –±—Ä–∞—É–∑–µ—Ä–∞..."
open http://localhost:8081

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ http://localhost:8081"
echo "üõë –î–ª—è –∑—É–ø–∏–Ω–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–∫—Ä–∏–π—Ç–µ —Ü–µ –≤—ñ–∫–Ω–æ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"
echo ""

# –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–∞–∫—Ä–∏—î
wait $SERVER_PID 